---
- hosts: localhost
  connection: local
  remote_user: root

  vars:
    ansible_python_interpreter: python
    ofndeploy_key_pub: "{{ lookup('file', '~/.ssh/ofndeploy_key.pub') }}"

  vars_files:
    - do_codes.yml

  tasks:
    - setup:
      register: d_setup
      tags: setup
    - debug: var=d_setup
      tags: setup

    - name: ensure ofndeploy_key is present
      digital_ocean_sshkey: >
          state=present
          name=ofndeploy_key
          ssh_pub_key={{ ofndeploy_key_pub }}
          client_id={{ ansible_env.DO_CLIENT_ID }}
          api_key={{ ansible_env.DO_API_KEY }}

    - name: create digital ocean droplet
      digital_ocean: >
          state=present
          name=test.ofn-deploy
          client_id={{ ansible_env.DO_CLIENT_ID }}
          api_key={{ ansible_env.DO_API_KEY }}
          size_id={{ do_sizes_1gb }}
          region_id={{ do_regions_lon1 }}
          image_id={{ do_images_ubuntu_14_04_x64 }}
          unique_name=yes
          ssh_key_ids=ofndeploy_key
      register: ofn_test_droplet

    - debug: msg="Droplet is {{ ofn_test_droplet.droplet }}"
    - debug: msg="ID is {{ ofn_test_droplet.droplet.id }}"
    - debug: msg="IP is {{ ofn_test_droplet.droplet.ip_address }}"

    - name: create droplet inventory
      template: src=ofn_deployment_inventory.j2 dest=~/ofn_deployment_inventory

    - name: save droplet information
      template: src=ofn_droplet.yml.j2 dest=~/ofn_droplet.yml



